#!/var/ossec/framework/python/bin/python3

import sys
import os
import json
import re
import ipaddress
import socket
import requests
from socket import socket as unix_socket, AF_UNIX, SOCK_DGRAM
from requests.exceptions import ConnectionError

# ---------------------------------------------------
# Wazuh socket configuration
# ---------------------------------------------------
pwd = os.path.dirname(os.path.dirname(os.path.realpath(__file__)))
socket_addr = f"{pwd}/queue/sockets/queue"

def send_event(msg, agent=None):
    if not agent or agent.get("id") == "000":
        string = f"1:misp:{json.dumps(msg)}"
    else:
        string = "1:[{0}] ({1}) {2}->misp:{3}".format(
            agent["id"],
            agent["name"],
            agent.get("ip", "any"),
            json.dumps(msg),
        )

    sock = unix_socket(AF_UNIX, SOCK_DGRAM)
    sock.connect(socket_addr)
    sock.send(string.encode())
    sock.close()

# ---------------------------------------------------
# Read alert file
# ---------------------------------------------------
with open(sys.argv[1]) as alert_file:
    alert = json.loads(alert_file.read())

alert_output = {}

# ---------------------------------------------------
# MISP Configuration
# ---------------------------------------------------
misp_base_url = "https://172.16.2.4/attributes/restSearch/"
misp_api_auth_key = "GjEnvEBqIHWv0yvZFZIRyZjifEYMfMlSHsqo4tZ0"

misp_headers = {
    "Content-Type": "application/json",
    "Authorization": misp_api_auth_key,
    "Accept": "application/json",
}

# ---------------------------------------------------
# Helpers
# ---------------------------------------------------
sha256_regex = re.compile(r"\b[a-fA-F0-9]{64}\b")
domain_regex = re.compile(r"^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$")

def query_misp(value):
    url = misp_base_url + f"value:{value}"
    try:
        r = requests.get(url, headers=misp_headers, verify=False, timeout=10)
        return r.json()
    except ConnectionError:
        alert_output["integration"] = "misp"
        alert_output["misp"] = {"error": "Connection error to MISP"}
        send_event(alert_output, alert.get("agent"))
        sys.exit()

def process_misp_response(response):
    if response.get("response", {}).get("Attribute"):
        attr = response["response"]["Attribute"][0]
        alert_output["integration"] = "misp"
        alert_output["misp"] = {
            "event_id": attr["event_id"],
            "category": attr["category"],
            "type": attr["type"],
            "value": attr["value"],
        }
        send_event(alert_output, alert.get("agent"))

# ---------------------------------------------------
# Event source & type
# ---------------------------------------------------
event_source = alert["rule"]["groups"][0]
event_type = alert["rule"]["groups"][2]

# ---------------------------------------------------
# WINDOWS SYSMon
# ---------------------------------------------------
if event_source == "windows":

    # -------- File hash events --------
    if event_type in [
        "sysmon_event1",
        "sysmon_event6",
        "sysmon_event7",
        "sysmon_event15",
        "sysmon_event23",
        "sysmon_event24",
        "sysmon_event25",
    ]:
        hashes = alert["data"]["win"]["eventdata"].get("hashes", "")
        match = sha256_regex.search(hashes)
        if not match:
            sys.exit()

        value = match.group(0)
        process_misp_response(query_misp(value))

    # -------- Network connection (IPv4 only) --------
    elif event_type == "sysmon_event3":
        if alert["data"]["win"]["eventdata"].get("destinationIsIpv6") == "false":
            dst_ip = alert["data"]["win"]["eventdata"].get("destinationIp")
            try:
                if ipaddress.ip_address(dst_ip).is_global:
                    process_misp_response(query_misp(dst_ip))
            except Exception:
                sys.exit()
        else:
            sys.exit()

    # -------- DNS query (DOMAIN SUPPORT) --------
    elif event_type == "sysmon_event_22":
        domain = alert["data"]["win"]["eventdata"].get("queryName", "").lower()

        if not domain_regex.match(domain):
            sys.exit()

        # Query domain in MISP
        process_misp_response(query_misp(domain))

        # Try resolving domain to IP (optional)
        try:
            resolved_ip = socket.gethostbyname(domain)
            if ipaddress.ip_address(resolved_ip).is_global:
                process_misp_response(query_misp(resolved_ip))
        except Exception:
            pass

    else:
        sys.exit()

# ---------------------------------------------------
# LINUX SYSMON
# ---------------------------------------------------
elif event_source == "linux" and event_type == "sysmon_event3":
    if alert["data"]["eventdata"].get("destinationIsIpv6") == "false":
        dst_ip = alert["data"]["eventdata"].get("DestinationIp")
        try:
            if ipaddress.ip_address(dst_ip).is_global:
                process_misp_response(query_misp(dst_ip))
        except Exception:
            sys.exit()
    else:
        sys.exit()

# ---------------------------------------------------
# OSSEC FILE INTEGRITY (SHA256)
# ---------------------------------------------------
elif event_source == "ossec" and event_type == "syscheck_entry_added":
    sha256 = alert.get("syscheck", {}).get("sha256_after")
    if not sha256:
        sys.exit()

    process_misp_response(query_misp(sha256))

else:
    sys.exit()

version: "3.8"

services:

  cassandra:
    image: cassandra:4
    container_name: cassandra
    restart: unless-stopped
    environment:
      CASSANDRA_CLUSTER_NAME: TheHive
      MAX_HEAP_SIZE: 512M
      HEAP_NEWSIZE: 100M
    volumes:
      - cassandradata:/var/lib/cassandra
    networks:
      - SOC_NET
    healthcheck:
      test: ["CMD", "cqlsh", "-e", "describe keyspaces"]
      interval: 30s
      timeout: 10s
      retries: 10

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9
    container_name: hive-elasticsearch
    restart: unless-stopped
    mem_limit: 512m
    environment:
      discovery.type: single-node
      cluster.name: hive
      xpack.security.enabled: "false"
      xpack.ml.enabled: "false"
      xpack.watcher.enabled: "false"
      xpack.graph.enabled: "false"
      xpack.monitoring.enabled: "false"
      ES_JAVA_OPTS: "-Xms128m -Xmx128m"
      http.host: 0.0.0.0
    ports:
      - "127.0.0.1:9201:9200"
    volumes:
      - elasticsearchdata:/usr/share/elasticsearch/data
    networks:
      - SOC_NET

  minio:
    image: quay.io/minio/minio
    container_name: minio
    restart: unless-stopped
    command: ["minio", "server", "/data", "--console-address", ":9002"]
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9002:9002"
    volumes:
      - miniodata:/data
    networks:
      - SOC_NET

  thehive:
    image: strangebee/thehive:5.2
    container_name: thehive
    restart: unless-stopped
    mem_limit: 1500m
    depends_on:
      cassandra:
        condition: service_healthy
      elasticsearch:
        condition: service_started
      minio:
        condition: service_started
    ports:
      - "9000:9000"
    environment:
      JVM_OPTS: "-Xms1024M -Xmx1024M"
    command:
      - --secret
      - lab123456789
      - --cql-hostnames
      - cassandra
      - --index-backend
      - elasticsearch
      - --es-hostnames
      - elasticsearch
      - --s3-endpoint
      - http://minio:9002
      - --s3-access-key
      - minioadmin
      - --s3-secret-key
      - minioadmin
      - --s3-use-path-access-style
    volumes:
      - thehivedata:/etc/thehive
    networks:
      - SOC_NET

  cortex:
    image: thehiveproject/cortex:latest
    container_name: cortex
    restart: unless-stopped
    depends_on:
      - elasticsearch
    ports:
      - "9001:9001"
    environment:
      job_directory: /tmp/cortex-jobs
      docker_job_directory: /tmp/cortex-jobs
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/cortex-jobs:/tmp/cortex-jobs
      - ./cortex/logs:/var/log/cortex
      - ./cortex:/cortex
    networks:
      - SOC_NET

  misp_mysql:
    image: mysql:5.7
    container_name: misp_mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: mispdb
      MYSQL_USER: mispuser
      MYSQL_PASSWORD: misppass
      MYSQL_ROOT_PASSWORD: mispass
    command: >
      --bind-address=0.0.0.0
      --skip-name-resolve
    volumes:
      - mispsqldata:/var/lib/mysql
    networks:
      - SOC_NET

  redis:
    image: redis:latest
    container_name: redis
    restart: unless-stopped
    networks:
      - SOC_NET

  misp:
    image: coolacid/misp-docker:core-latest
    container_name: misp
    restart: unless-stopped
    depends_on:
      - misp_mysql
      - redis
    ports:
      - "8080:80"
      - "443:443"
    environment:
      MYSQL_HOST: misp_mysql
      MYSQL_DATABASE: mispdb
      MYSQL_USER: mispuser
      MYSQL_PASSWORD: misppass
      MYSQL_ROOT_PASSWORD: mispass
      MISP_ADMIN_EMAIL: mispadmin@lab.local
      MISP_ADMIN_PASSPHRASE: mispadminpass
      MISP_BASEURL: https://localhost
      TIMEZONE: Asia/Kolkata
      INIT: "true"
      CRON_USER_ID: "1"
      REDIS_FQDN: redis
    volumes:
      - ./server-configs:/var/www/MISP/app/Config
      - ./logs:/var/www/MISP/app/tmp/logs
      - ./files:/var/www/MISP/app/files
      - ./ssl:/etc/nginx/certs
    networks:
      - SOC_NET

  misp-modules:
    image: coolacid/misp-docker:modules-latest
    container_name: misp-modules
    restart: unless-stopped
    environment:
      REDIS_BACKEND: redis
    depends_on:
      - redis
      - misp_mysql
    networks:
      - SOC_NET

volumes:
  miniodata:
  cassandradata:
  elasticsearchdata:
  thehivedata:
  mispsqldata:

networks:
  SOC_NET:
    driver: bridge
